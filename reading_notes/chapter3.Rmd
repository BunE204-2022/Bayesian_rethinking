# Chapter 3 想象中的采样

本章开头作者引用了一个利用贝叶斯公式调查吸血鬼的案例，向我们展示了统计方法虽然有用，但面对低质量数据或极端样本时也是比较无力的。此处仅展示代码部分：

```{r}
Pr_Positive_Vampire <- 0.95#吸血鬼被测出阳性的概率
Pr_Positive_Mortal <- 0.01#人类被测出阳性的概率
Pr_Vampire <- 0.001#吸血鬼占总体的比例
Pr_Positive <- Pr_Positive_Vampire * Pr_Vampire +
Pr_Positive_Mortal * ( 1 - Pr_Vampire )
( Pr_Vampire_Positive <- Pr_Positive_Vampire*Pr_Vampire / Pr_Positive )#计算阳性个体中吸血鬼的比例
```

## 3.1 从网格逼近法得到的后验中抽样

我们就掷地球试验进行研究，网格逼近法得到的后验中抽取10000个样本，并绘制出这些样本的散点图和密度曲线，具体如下所示：

```{r}
p_grid <- seq( from=0 , to=1 , length.out=1000 )
prob_p <- rep( 1 , 1000 )
prob_data <- dbinom( 6 , size=9 , prob=p_grid )
posterior <- prob_data * prob_p
posterior <- posterior / sum(posterior)
samples <- sample( p_grid , prob=posterior , size=1e4 , replace=TRUE )
plot(samples)
library(rethinking)
dens(samples)
```

以上步骤虽然仅仅是重复了我们在前一章中进行的计算并绘制了图表，但是它们可以帮助我们更好地理解后验分布。

## 3.2 抽样总结

### 3.2.1 通过边界来定义的区间

在后验中，我们可以通过一个确定的边界来找到对应的区间。例如在掷地球实验中，我们可以通过给定p值的一个取值范围，从而得到这个范围在后验中对应的总可能性。代码如下：

```{r}
sum(posterior[p_grid<0.5])
```
由于在计算机中，后验是通过样本数值模拟的方法得出的，因此我们也可以通过给定样本取值的一个区间，从而得到这个范围在后验中对应的总可能性。

```{r}
sum(samples<0.5)/1e4
```

### 3.2.2 通过比重来定义的区间

在频率学派的研究中，置信区间(CONFIDENCE INTERVAL)是通过比重来定义的区间的典型代表，它代表所有样本中比例为$1-\alpha$的样本将会落在该区间中。而在贝叶斯统计中，可将置信区间类比为后验概率的一个可信区间(CREDIBLE INTERVAL),它由两个参数值构成，而这两个参数值构成的区间中包含了值为$1-\alpha$的后验概率。而本书为了避免混淆置信区间和可信区间，采用兼容性区间(COMPATIBILITY INTERVAL)来替代可信区间。

本书作者给出了一些利用r语言来求解兼容性区间的代码，值得注意是利用后验中的样本来构造这些区间要比用网格逼近法构造要简单

仍然是以掷地球实验为例。利用后验中的样本来构造兼容性区间

```{r}
quantile(samples,0.8)#获取一个从p=0开始，总后验概率为0.8的兼容性区间的右端点
```
特别的，对于双尾概率相等的兼容性区间，我们将它命名为分位数区间（percentile intervals,简称为PI）,当后验概率分布比较对称时，PI的效果较好。代码实现如下面所示。

```{r}
quantile(samples, c(0.1,0.9))
```

![](6.png)
但是当后验概率分布不对称时，PI会影响我们的正确判断。考虑掷地球实验中我们进行了3次实验，实验结果均为水朝上，此时我们再观察PI的效果，代码实现如下：

```{r}
p_grid <- seq( from=0 , to=1 , length.out=1000 )
prior <- rep(1,1000)
likelihood <- dbinom( 3 , size=3 , prob=p_grid )
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)
samples <- sample( p_grid , size=1e4 , replace=TRUE , prob=posterior )
PI( samples , prob=0.5 )
```
![](8.png)

显而易见该区间甚至没有把可能性最大的p=1包括进去，可见估计效果较差。此时我们引入另一种区间取法：最大后验密度区间（HIGHEST POSTERIOR DENSITY INTERVAL,简称为HDPI）,对于某个特定的概率比重而言，HDPI的区间长度是最短的，代码实现如下图所示：

```{r}
HPDI( samples , prob=0.5 )
```
但是值得注意的是HDPI对于抽样量很敏感，样本量小时效果较差。

总而言之，如果我们使用两种区间估计的结果出入较大时，我们尽量应该试图画出后验分布的完整分布，而非用兼容性区间进行估计。

### 3.2.3 点估计

我们在贝叶斯估计中如果要进行点估计，则很自然地我们会选择一个拥有最高后验概率的参数估计值即最大后验估计（maximum a posteriori, MAP）。还是以掷地球实验为例，假设我们投掷三次得到了三次水。我们可以用电脑得到这一估计，代码如下：

```{r}
 p_grid[ which.max(posterior) ]
```
![](7.png)

问题在于我们为什么要选择这一点估计，而非后验均值或后验中位数？

此时我们就要引入一个新的概念：损失函数（LOSS FUNCTION）。损失函数是用来形容选择某一点估计的代价的准则，它实质上和点估计与参数真值的距离成比例。

仍然采用上面的掷地球实验为例，假设我们取p=0.5作为我们的点估计，则对于我们通过模拟得到的后验而言，损失函数可以用以下的代码进行计算：
```{r}
sum( posterior*abs( 0.5 - p_grid ) )
```
此处的后验概率实际上是在对每一个样本点的损失进行加权。

而实际上如果我们要对一系列点估计依据它们的损失函数进行比较的话，我们可以使用sapply（）函数进行简化，选择损失函数最小的点估计，代码如下：

```{r}
loss <- sapply( p_grid , function(d) sum( posterior*abs( d - p_grid ) ) )
p_grid[ which.min(loss) ]
```
此时我们可以依据损失函数来选择0.84作为p的点估计，这也正是后验中位数。

需要注意的是损失函数的不同形式也会导致不同的点估计结果，上文中损失函数采用了｜d-p｜的形式后确定了后验中位数为点估计，但如果损失函数采用（d-p）^2的形式，我们则会认为后验均值才是比较好的结果。

## 3.3 抽样预测

后验分布样本的另外一个常见功能是为我们提供一个了解当前模型可能产生什么样本的简单方法，本章的最后一节将介绍如何模拟样本以及进行一些简单的模型评估。

### 3.3.1 虚拟数据

现在对这两个章节一直使用的投掷球模型进行总结。

首先，水域覆盖率P是存在且固定的，该值是我们想要估计的，将球投掷后得到观测，得到"水面"的概率是p，得到"陆地"的概率是 1-p

这些假设不仅让我们获得观测的情况下推断每个P取值的可能性，还让我们能够从后验分布中模拟模型可能产生的样本，这是因为给定观测，似然函数能够告诉你得到该观测的似然值，如果给定参数，似然函数定义了观测值的分布，可以根据该分布模拟可能的观测值。我们将这些模拟的数据称为**虚拟数据**，说明这不是真实的观测数据，而是一种近似或者模拟

在投掷球模型中，虚拟数据来自如下的二项似然函数：

$$ Pr(W|N, p) = \frac{N!}{W!(N-W)!}p^W(1-p)^{N-W}$$ 其中w是观测到水面的次数，n是总投掷次数。假设n=2，一共投了2次球，那么观测的水面的次数可能取值只有3个：0次，1次和2次。给定P的值，你能很容易计算出每个观测对应的似然函数。

假设P=0.7，该值大概是真是的地球表面海洋覆盖率：

```{r}
dbinom(0:2 , size = 2,prob = 0.7)
```

这意味着w=0的概率为9%，w=1的概率为42%，w=2的概率为49%。

现在，我们通过这些似然值来模拟观测，可以用rbinom()函数来实现，这里生成10个样本：

```{r}
dummy_w <- rbinom(10,size = 2,prob = 0.7)
table(dummy_w)/10
```

现在，生成100 000个虚拟数据，检查下每个观测出现的频率是否与相应的似然值成比例：

```{r}
dummy_w1 <- rbinom(1e5,size = 2,prob = 0.7)
table(dummy_w1)/1e5
```

这些取值和之前计算的理论似然值非常相近，由于抽样的随机性，他们可能并不完全相等。

只执行2次貌似不够，现在假设一共投掷了9次，同样模拟100 000个观测：

```{r}
dummy_w2 <- rbinom(1e5,size = 9,prob = 0.7)
simplehist(dummy_w2,xlab='dummy water count')
```

![](https://s4.ax1x.com/2022/02/10/HNsYee.png)

以上就是如何进行最基本的样本模拟

### 3.3.2 模型检查

模型不可能完美，因此我们要有自己的判断和取舍，现在，我们结合模拟观测（上一节讲到的）并通过后验分布模拟参数取值。

首先，观测具有不确定性。预测的样本具有不确定性，因为即使你确切的知道了P的取值，也不能知道下一次投球的结果（除非p=0或p=1)

其次，p的取值具有不确定性。这种不确定性体现了在后验分布中，由于P具有不确定性，于是一切与P有关的也具有不确定性。

于是，从模型中得到的预测包括了两种不确定性：**观测的不确定性和参数取值的不确定性**。

接着，我们将参数的取值的不确定性代入预测。这里要做的只是将不同取值的P对应的预测分布在P的后验分布上取平均。每个P对应一个观测的分布，计算出该样本分布后，你可以找到这个P取值对应的后验分布概率，然后用后验分布概率加权取平均，得到**后验预测分布**。

下图给出了这一加权的过程。

（1）图的上部是参数的后验分布，垂直标注的是10个不同的参数取值；

（2）每个参数取值对应的观测样本分布是中间那行条形图（也就是上一节中讲到的）；

（3）最后，在图的最底部，我们将所有p取值通过后验概率结合起来，计算得到没和可能观测的加权平均频率。

![](https://s4.ax1x.com/2022/02/10/HNsry8.png) 